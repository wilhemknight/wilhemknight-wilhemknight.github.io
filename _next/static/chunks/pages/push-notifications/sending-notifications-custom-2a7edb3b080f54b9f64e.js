_N_E=(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[200],{"7ljp":function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h}));var o=n("q1tI"),i=n.n(o);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,o,i=function(e,t){if(null==e)return{};var n,o,i={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=i.a.createContext({}),l=function(e){var t=i.a.useContext(p),n=t;return e&&(n="function"===typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=l(e.components);return i.a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},b=i.a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,r=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),u=l(n),b=o,h=u["".concat(r,".").concat(b)]||u[b]||d[b]||a;return n?i.a.createElement(h,s(s({ref:t},p),{},{components:n})):i.a.createElement(h,s({ref:t},p))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"===typeof e||o){var a=n.length,r=new Array(a);r[0]=b;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"===typeof e?e:o,r[1]=s;for(var p=2;p<a;p++)r[p]=n[p];return i.a.createElement.apply(null,r)}return i.a.createElement.apply(null,n)}b.displayName="MDXCreateElement"},HALo:function(e,t,n){"use strict";function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}n.d(t,"a",(function(){return o}))},Qetd:function(e,t,n){"use strict";var o=Object.assign.bind(Object);e.exports=o,e.exports.default=e.exports},RSQ3:function(e,t,n){"use strict";n.r(t),n.d(t,"meta",(function(){return s})),n.d(t,"headings",(function(){return c})),n.d(t,"default",(function(){return l}));var o=n("HALo"),i=n("dhJC"),a=(n("q1tI"),n("7ljp")),r=["components"],s={title:"Sending Notifications with APNs & FCM",hideFromSearch:!0},c=[{depth:2,type:"text",title:"How do I write my own APNs & FCM servers?"},{depth:2,type:"text",title:"FCM Server"},{depth:3,type:"text",title:"Where can I find my FCM server key?"},{depth:2,type:"text",title:"APNs Server"},{depth:3,type:"text",title:"Authorization"},{depth:3,type:"text",title:"HTTP/2 Connection"},{depth:2,type:"text",title:"Payload Formats"},{depth:3,type:"text",title:"iOS"},{depth:3,type:"text",title:"Android"},{depth:3,type:"text",title:"Firebase notification types"},{depth:2,type:"text",title:"Next steps"}],p={meta:s,headings:c};function l(e){var t=e.components,n=Object(i.a)(e,r);return Object(a.b)("wrapper",Object(o.a)({},p,n,{components:t,mdxType:"MDXLayout"}),Object(a.b)("p",null,"Communicating directly with APNs and FCM is much more complicated than sending notifications through ",Object(a.b)("a",{parentName:"p",href:"/push-notifications/sending-notifications/"},"Expo's push notification service"),", so you should only use this feature if you're prepared to undertake that complexity. Here are a few things you'll have to handle yourself if you choose to write your own server for FCM and APNs:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"Differentiating between native iOS & Android device tokens on your backend"),Object(a.b)("li",{parentName:"ul"},"Twice the amount of backend code to write and maintain (code for communicating with FCM, and then code for communicating with APNs)"),Object(a.b)("li",{parentName:"ul"},"Fetching responses from FCM and APNs to check if your notification went through, error handling, credentials management")),Object(a.b)("p",null,"That being said, sometimes you need finer-grained control over your notifications, so communicating directly with APNs and FCM is necessary. The Expo platform does not lock you into using Expo's application services, and the ",Object(a.b)("inlineCode",{parentName:"p"},"expo-notifications")," API is push-service agnostic (you can use it with any push notification service)."),Object(a.b)("h2",{id:"how-do-i-write-my-own-apns--fcm-servers"},"How do I write my own APNs & FCM servers?"),Object(a.b)("p",null,"Before we begin communicating directly with APNs & FCM, there is one client-side change you'll need to make in your app. When using Expo's notification service, you collect the ",Object(a.b)("inlineCode",{parentName:"p"},"ExponentPushToken")," with ",Object(a.b)("a",{parentName:"p",href:"/versions/latest/sdk/notifications/#getexpopushtokenasyncoptions-expotokenoptions-expopushtoken"},Object(a.b)("inlineCode",{parentName:"a"},"getExpoPushTokenAsync")),". Now that you're not using Expo's notification service, you'll need to collect the native device token instead with ",Object(a.b)("a",{parentName:"p",href:"/versions/latest/sdk/notifications/#getdevicepushtokenasync-devicepushtoken"},Object(a.b)("inlineCode",{parentName:"a"},"getDevicePushTokenAsync")),"."),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-diff"},"import * as Notifications from 'expo-notifications';\n...\n- const token = (await Notifications.getExpoPushTokenAsync()).data;\n+ const token = (await Notifications.getDevicePushTokenAsync()).data:\n// send token off to your server\n")),Object(a.b)("p",null,"Now that you have your native device token, we can start to implement our servers. Below are some very minimal examples of communicating with FCM and APNs:"),Object(a.b)("h2",{id:"fcm-server"},"FCM Server"),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},"This documentation is based off of ",Object(a.b)("a",{parentName:"p",href:"https://firebase.google.com/docs/cloud-messaging/http-server-ref"},"Google's documentation"),", and we're just going to cover the basics here to get you started.")),Object(a.b)("p",null,"Communicating with FCM is as simple as sending a POST request, but before sending or receiving any notifications, you'll need to follow the steps ",Object(a.b)("a",{parentName:"p",href:"/push-notifications/using-fcm/"},"in this documentation")," to configure FCM (and get your ",Object(a.b)("inlineCode",{parentName:"p"},"FCM-SERVER-KEY"),")."),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},"Note: the following example uses FCM's legacy HTTP API, since the credentials setup for that is the same as it is for the Expo notifications service, so there's no additional work needed on your part. If you'd rather use FCM's HTTP v1 API, follow ",Object(a.b)("a",{parentName:"p",href:"https://firebase.google.com/docs/cloud-messaging/migrate-v1"},"this migration guide"),".")),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-js"},"await fetch('https://fcm.googleapis.com/fcm/send', {\n  method: 'POST',\n  headers: {\n    'Content-Type': 'application/json',\n    Authorization: `key=<FCM-SERVER-KEY>`,\n  },\n  body: JSON.stringify({\n    to: '<NATIVE-DEVICE-PUSH-TOKEN>',\n    priority: 'normal',\n    data: {\n      experienceId: '@yourExpoUsername/yourProjectSlug',\n      scopeKey: '@yourExpoUsername/yourProjectSlug',\n      title: \"\\uD83D\\uDCE7 You've got mail\",\n      message: 'Hello world! \\uD83C\\uDF10',\n    },\n  }),\n});\n")),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"The ",Object(a.b)("inlineCode",{parentName:"strong"},"experienceId")," and ",Object(a.b)("inlineCode",{parentName:"strong"},"scopeKey")," fields are required"),", otherwise your notifications will not go through to your app. FCM has their full list of supported fields in the notification payload ",Object(a.b)("a",{parentName:"p",href:"https://firebase.google.com/docs/cloud-messaging/http-server-ref#notification-payload-support"},"here"),", and you can see which ones are supported by ",Object(a.b)("inlineCode",{parentName:"p"},"expo-notifications")," on Android by looking at ",Object(a.b)("a",{parentName:"p",href:"/versions/latest/sdk/notifications/#firebaseremotemessage"},"the documentation"),"."),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},"FCM also provides some server-side libraries in a few languages you can use instead of raw ",Object(a.b)("inlineCode",{parentName:"p"},"fetch")," requests. ",Object(a.b)("a",{parentName:"p",href:"https://firebase.google.com/docs/cloud-messaging/send-message#node.js"},"See here for more info"),".")),Object(a.b)("h3",{id:"where-can-i-find-my-fcm-server-key"},"Where can I find my FCM server key?"),Object(a.b)("p",null,"Your FCM server key can be found by making sure you've followed ",Object(a.b)("a",{parentName:"p",href:"/push-notifications/using-fcm/"},"this documentation"),", and under ",Object(a.b)("inlineCode",{parentName:"p"},"Uploading Server Credentials"),", instead of uploading your FCM key to Expo, you would use that key directly in your server (as the ",Object(a.b)("inlineCode",{parentName:"p"},"FCM-SERVER-KEY")," in the example above)."),Object(a.b)("h2",{id:"apns-server"},"APNs Server"),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},"This documentation is based off of ",Object(a.b)("a",{parentName:"p",href:"https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html#//apple_ref/doc/uid/TP40008194-CH8-SW1"},"Apple's documentation"),", and we're just going to cover the basics here to get you started.")),Object(a.b)("p",null,"Communicating with APNs is a little more complicated than with FCM. There are some libraries that wrap all of this functionality into one or two function calls (like ",Object(a.b)("a",{parentName:"p",href:"https://github.com/node-apn/node-apn"},Object(a.b)("inlineCode",{parentName:"a"},"node-apn")),"), but in this example we're going to use the minimum required libraries to give you a good understanding of what's happening."),Object(a.b)("h3",{id:"authorization"},"Authorization"),Object(a.b)("p",null,"The first thing you need before sending requests to APNs is permission to send notifications to your app, which is going to be granted via a JSON web token. This web token is generated using these iOS developer credentials:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"APN key (",Object(a.b)("inlineCode",{parentName:"li"},".p8")," file) associated with your app"),Object(a.b)("li",{parentName:"ul"},"Key ID of the above ",Object(a.b)("inlineCode",{parentName:"li"},".p8")," file"),Object(a.b)("li",{parentName:"ul"},"Your Apple Team ID")),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-js"},'const jwt = require("jsonwebtoken");\nconst authorizationToken = jwt.sign(\n  {\n    iss: "YOUR-APPLE-TEAM-ID"\n    iat: Math.round(new Date().getTime() / 1000),\n  },\n  fs.readFileSync("./path/to/appName_apns_key.p8", "utf8"),\n  {\n    header: {\n      alg: "ES256",\n      kid: "YOUR-P8-KEY-ID",\n    },\n  }\n);\n')),Object(a.b)("h3",{id:"http2-connection"},"HTTP/2 Connection"),Object(a.b)("p",null,"Now that we have our ",Object(a.b)("inlineCode",{parentName:"p"},"authorizationToken"),", we can open up an HTTP/2 connection to Apple's servers. In development, you'll want to send requests to ",Object(a.b)("inlineCode",{parentName:"p"},"api.development.push.apple.com"),", but in production requests should go to ",Object(a.b)("inlineCode",{parentName:"p"},"api.push.apple.com"),"."),Object(a.b)("p",null,"Here's how to construct your request:"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-js"},"const http2 = require('http2');\n\nconst client = http2.connect(\n  IS_PRODUCTION ? 'https://api.push.apple.com' : 'https://api.sandbox.push.apple.com'\n);\n\nconst request = client.request({\n  ':method': 'POST',\n  ':scheme': 'https',\n  'apns-topic': 'YOUR-BUNDLE-IDENTIFIER',\n  ':path': '/3/device/' + nativeDeviceToken, // This is the native device token you grabbed client-side\n  authorization: `bearer ${authorizationToken}`, // This is the JSON web token we generated in the \"Authorization\" step above\n});\nrequest.setEncoding('utf8');\n\nrequest.write(\n  JSON.stringify({\n    aps: {\n      alert: {\n        title: \"\\uD83D\\uDCE7 You've got mail!\",\n        body: 'Hello world! \\uD83C\\uDF10',\n      },\n    },\n    experienceId: '@yourExpoUsername/yourProjectSlug', // Required when testing in the Expo Go app\n    scopeKey: '@yourExpoUsername/yourProjectSlug', // Required when testing in the Expo Go app\n  })\n);\nrequest.end();\n")),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},"This example is ",Object(a.b)("strong",{parentName:"p"},"very")," minimal, and includes no error handling nor connection pooling. For testing purposes, you should refer to ",Object(a.b)("a",{parentName:"p",href:"https://github.com/expo/fyi/blob/master/sendNotificationToAPNS.js"},"this example code"),", instead.")),Object(a.b)("p",null,"APNs provides their full list of supported fields in the notification payload ",Object(a.b)("a",{parentName:"p",href:"https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/PayloadKeyReference.html#//apple_ref/doc/uid/TP40008194-CH17-SW1"},"here"),"."),Object(a.b)("h2",{id:"payload-formats"},"Payload Formats"),Object(a.b)("p",null,"The examples above show bare minimum notification requests, which aren't that exciting. You probably want to send category identifiers, custom sounds, icons, custom key-value pairs, etc. ",Object(a.b)("inlineCode",{parentName:"p"},"expo-notifications")," documents all the fields it supports, and here are the payloads we send in our notifications service, as an example:"),Object(a.b)("h3",{id:"ios"},"iOS"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-json"},'{\n  "aps": {\n    "alert": {\n      "title": title of your message,\n      "subtitle": subtitle of your message (shown below title, above body),\n      "body": body of your message,\n      "launch-image": the name of the launch image file to display,\n    },\n    "category": the category associated with this notification,\n    "badge": number to set badge count to upon notification\'s arrival,\n    "sound": the sound to play when the notification is received,\n    "thread-id": app-specific identifier for grouping related notifications\n  },\n  "body": { object of key-value pairs },\n  "experienceId": "@yourExpoUsername/yourProjectSlug",\n  "scopeKey": "@yourExpoUsername/yourProjectSlug",\n}\n')),Object(a.b)("h3",{id:"android"},"Android"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-json"},'{\n  "token": native device token string,\n  "collapse_key": string that identifies notification as collapsable,\n  "priority": "normal" || "high",\n  "data": {\n    "experienceId": "@yourExpoUsername/yourProjectSlug",\n    "scopeKey": "@yourExpoUsername/yourProjectSlug",\n    "title": title of your message,\n    "message": body of your message,\n    "channelId": the android channel ID associated with this notification,\n    "categoryId": the category associated with this notification,\n    "icon": the icon to show with this notification,\n    "link": the link this notification should open,\n    "sound": boolean or the custom sound file you\'d like to play,\n    "vibrate": "true" | "false" | number[],\n    "priority": AndroidNotificationPriority, // https://docs.expo.dev/versions/latest/sdk/notifications/#androidnotificationpriority\n    "badge": the number to set the icon badge to,\n    "body": { object of key-value pairs }\n  }\n}\n')),Object(a.b)("h3",{id:"firebase-notification-types"},"Firebase notification types"),Object(a.b)("p",null,"There are two types of Firebase Cloud Messaging messages: notification and data messages (see the ",Object(a.b)("a",{parentName:"p",href:"https://firebase.google.com/docs/cloud-messaging/concept-options#notifications_and_data_messages"},"official documentation")," for more information). Although the naming can be confusing, we'll try to clear things up:"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},Object(a.b)("strong",{parentName:"p"},"Notification")," messages are only handled (and displayed) by the Firebase library, meaning they won't necessarily wake the app, and ",Object(a.b)("inlineCode",{parentName:"p"},"expo-notifications")," will not be made aware that your app has received any notification.")),Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},Object(a.b)("strong",{parentName:"p"},"Data")," messages, on the other hand, are not handled by the Firebase library at all- they are immediately handed off to your app for processing. That's where ",Object(a.b)("inlineCode",{parentName:"p"},"expo-notifications")," comes in and interprets the data payload, then takes further action based on that data. ",Object(a.b)("strong",{parentName:"p"},"In almost all cases, this is the type of notification you want to send.")))),Object(a.b)("p",null,'When sending a message directly through Firebase, if you send a message of type "notification" instead of "data", you won\'t know if a user interacted with the notification (no ',Object(a.b)("inlineCode",{parentName:"p"},"onNotificationResponse")," event), nor will you be able to parse the notification payload for any data in your notification event-related listeners."),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},"Note: Using notification-type messages may have its upsides when you need a configuration option that has not been exposed by ",Object(a.b)("inlineCode",{parentName:"p"},"expo-notifications")," yet, but in general it may lead to less predictable situations than using only data-type messages (plus it's not our field of responsibility, you'd have to go to Google to report issues).")),Object(a.b)("p",null,"How do you send data-type messages instead of notification-type messages? Since code is worth more than a million words, let's see examples of each type using the Node.js Firebase Admin SDK:"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-js"},'const devicePushToken = /* ... */;\nconst options = /* ... */;\n\n// \u274c The following payload has a root-level notification object\n// and thus it will NOT trigger expo-notifications and may not work\n// as expected.\nadmin.messaging().sendToDevice(\n  devicePushToken,\n  {\n    notification: {\n      title: "This is a notification-type message",\n      body: "`expo-notifications` will never see this \ud83d\ude22",\n    },\n    data: {\n      photoId: 42,\n    },\n  },\n  options\n);\n\n// \u2705 There is no "notification" key in the root level of the payload\n// so the message is a "data" message, thus triggering expo-notifications.\nadmin.messaging().sendToDevice(\n  devicePushToken,\n  {\n    data: {\n      title: "This is a data-type message",\n      message: "`expo-notifications` events will be triggered \ud83e\udd17",\n      // \u26a0\ufe0f Notice the schema of this payload is different\n      // than that of Firebase SDK. What is there called "body"\n      // here is a "message". For more info see:\n      // https://docs.expo.dev/versions/latest/sdk/notifications/#android-push-notification-payload-specification\n\n      body:                              // \u26a0\ufe0f As per Android payload format specified above, the\n        JSON.stringify({ photoId: 42 }), // additional "data" should be placed under "body" key.\n    },\n  },\n  options\n);\n')),Object(a.b)("h2",{id:"next-steps"},"Next steps"),Object(a.b)("p",null,"Now that you can send notifications to your app, set your app up for ",Object(a.b)("a",{parentName:"p",href:"/push-notifications/receiving-notifications/"},"receiving notifications and taking action based on those events"),"!"))}l.isMDXComponent=!0},dhJC:function(e,t,n){"use strict";function o(e,t){if(null==e)return{};var n,o,i=function(e,t){if(null==e)return{};var n,o,i={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}n.d(t,"a",(function(){return o}))},"zdv+":function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/push-notifications/sending-notifications-custom",function(){return n("RSQ3")}])}},[["zdv+",1,0]]]);